<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Ø¹Ø¯Ù‘Ø§Ø¯ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„ØµØºØ§Ø±</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#FF7AC3">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø¨Ø·Ø§Ù„">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <style>
    :root{ --bg:#FFFAF1;--card:#FFFFFF;--ink:#1f2328;--muted:#6b7280;--accent:#FF7AC3;--border:#ffe3b8; }
    *{ box-sizing:border-box }
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% -10%, #FFF0D6 0%, var(--bg) 40%),
        radial-gradient(800px 500px at 110% 0%, #FFE6F4 0%, transparent 50%),
        radial-gradient(800px 600px at -5% 100%, #E7F6FF 0%, transparent 50%);
      color:var(--ink);
      font-family:'Noto Sans Arabic', system-ui, -apple-system, Segoe UI, Roboto, Tahoma, sans-serif;
    }
    header{ position:sticky; top:0; background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.75)); backdrop-filter:blur(8px); border-bottom:2px solid var(--border); padding:10px 16px; }
    h1{ margin:0; font-size:22px; display:flex; gap:10px; align-items:center }
    .mascot{ width:34px; height:34px }

    main{ padding:14px; display:grid; gap:14px; max-width:980px; margin:0 auto }
    .card{ background:var(--card); border:2px solid var(--border); border-radius:22px; padding:14px; box-shadow:0 6px 20px #00000010 }
    .controls{ display:flex; flex-wrap:wrap; gap:10px }
    button{ border:none; border-radius:16px; padding:12px 16px; font-size:18px; cursor:pointer; transition:.15s transform }
    button:active{ transform:scale(.98) }
    .btn-primary{ background:linear-gradient(90deg,var(--accent),#FFB86C); color:#2b0b1e }
    .btn{ background:#F1F5F9; color:#111827 }
    .pill{ display:inline-flex; gap:8px; align-items:center; padding:10px 12px; border-radius:999px; background:#F9FAFB; border:2px dashed var(--border) }
    .swatch{ width:22px; height:22px; border-radius:8px; border:2px solid #0002 }

    .video-wrap{ position:relative; border-radius:22px; overflow:hidden; border:2px solid var(--border); background:#000 }
    video{ width:100%; height:auto; display:block }
    canvas{ display:none }
    .roi{ position:absolute; border:4px dashed #fff; inset:auto; left:50%; top:50%; transform:translate(-50%,-50%); width:min(50vmin,360px); height:min(50vmin,360px); border-radius:20px; box-shadow:0 0 0 6px #00000030 inset }

    .msg{ font-size:22px; line-height:1.7; margin:8px 0 0 }
    .msg .big{ font-weight:800 }

    /* BIG popup */
    .celebrate{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:50 }
    .celebrate.active{ display:grid }
    .cele-card{ background:#fff; border:4px solid var(--border); border-radius:32px; padding:28px; width:min(92vw, 820px); box-shadow:0 28px 80px #00000055; }
    .cele-text{ margin:0; font-size:clamp(22px, 4.2vw, 38px); line-height:1.6; text-align:center; }
  </style>
</head>
<body>
  <header>
    <h1>
      <svg class="mascot" viewBox="0 0 64 64" aria-hidden="true">
        <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0%" stop-color="#FF7AC3"/><stop offset="100%" stop-color="#60A5FA"/></linearGradient></defs>
        <circle cx="32" cy="32" r="30" fill="url(#g)"/>
        <circle cx="24" cy="26" r="5" fill="#fff"/><circle cx="40" cy="26" r="5" fill="#fff"/>
        <path d="M20 42q12 10 24 0" stroke="#fff" stroke-width="5" fill="none" stroke-linecap="round"/>
      </svg>
      Ø¹Ø¯Ù‘Ø§Ø¯ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„ØµØºØ§Ø±
    </h1>
  </header>

  <main>
    <section class="card">
      <div class="controls">
        <button class="btn-primary" id="btnStart">ğŸ¥ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button class="btn" id="btnStop">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
        <span class="pill"><span class="swatch" id="swatch"></span><span id="colorName">â€”</span></span>
      </div>

      <div class="video-wrap">
        <video id="video" playsinline autoplay muted></video>
        <div class="roi" id="roi"></div>
      </div>

      <canvas id="canvas"></canvas>

      <p class="msg" id="msg">
        â­ï¸ <span class="big">Ù‡ÙŠØ§ ÙŠØ§ Ø¨Ø·Ù„/Ø©!</span> Ø¶Ø¹/ÙŠ Ø§Ù„ÙƒØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ù†Ù‚Ù‘Ø· Ù„ÙŠÙƒØªØ´Ù Ø§Ù„Ù„ÙˆÙ† ÙˆÙŠØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.
      </p>
    </section>

    <!-- Keep only tuning sliders -->
    <section class="card grid">
      <div>
        <label>Ø­Ø¬Ù… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù‚ÙŠØ§Ø³</label>
        <input type="range" id="roiSize" min="30" max="80" value="50" />
      </div>
      <div>
        <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªØ´Ø¨Ø¹ (S)</label>
        <input type="range" id="minSat" min="0" max="100" value="25" />
      </div>
      <div>
        <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¥Ø¶Ø§Ø¡Ø© (V)</label>
        <input type="range" id="minVal" min="0" max="100" value="20" />
      </div>
      <div>
        <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø¥Ø¶Ø§Ø¡Ø© (Ù„Ù„Ø£Ø³ÙˆØ¯)</label>
        <input type="range" id="maxValBlack" min="0" max="100" value="18" />
      </div>
    </section>
  </main>

  <!-- Popup -->
  <div class="celebrate" id="cele">
    <div class="cele-card"><p class="cele-text" id="celeText">â€”</p></div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const roiBox = document.getElementById('roi');
    const roiSize = document.getElementById('roiSize');
    const minSat = document.getElementById('minSat');
    const minVal = document.getElementById('minVal');
    const maxValBlack = document.getElementById('maxValBlack');
    const swatch = document.getElementById('swatch');
    const colorNameEl = document.getElementById('colorName');

    const cele = document.getElementById('cele');
    const celeText  = document.getElementById('celeText');

    let stream=null, rafId=null, lastColor="";
    let lastTriggerAt = 0, stableColor = "", sameCount = 0, noColorCount = 0;

    // Only the 5 target colors
    const TARGETS = ['RED','GREEN','BLUE','YELLOW','PURPLE'];

    // Final Arabic messages
    const messages = {
      YELLOW: "Ø£Ù†Øª ØªØ´Ø¹Ø± Ø¨Ø§Ù„Ø³Ø¹Ø§Ø¯Ø©! Ø´Ø§Ø±Ùƒ Ù…Ø§Ù…Ø§ Ø£Ùˆ Ø¨Ø§Ø¨Ø§ Ø¨Ù…Ø§ Ø¬Ø¹Ù„Ùƒ Ø³Ø¹ÙŠØ¯Ù‹Ø§ Ø§Ù„ÙŠÙˆÙ….",
      BLUE:   "ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ùƒ Ø­Ø²ÙŠÙ†... Ù…Ù† Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ø£Ù† Ù†Ø­Ø²Ù† Ø£Ø­ÙŠØ§Ù†Ù‹Ø§. Ø£Ø®Ø¨Ø± Ù…Ù† ØªØ­Ø¨ Ø¨Ù…Ø§ ÙŠØ¶Ø§ÙŠÙ‚Ùƒ.",
      RED:    "Ø£Ù†Øª ØºØ§Ø¶Ø¨ Ø§Ù„Ø¢Ù†ØŒ Ø®Ø° Ù†ÙØ³Ø§Ù‹ Ø¹Ù…ÙŠÙ‚Ø§Ù‹ØŒ Ø«Ù… Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø© Ù„ØªÙØ±Øº ØºØ¶Ø¨Ùƒ.",
      PURPLE: "ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ùƒ Ø®Ø§Ø¦Ù... ØªØ°ÙƒØ± Ø£Ù†Ùƒ Ø¨Ø£Ù…Ø§Ù† Ù‡Ù†Ø§ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø¯Ø« Ù…Ø¹ÙŠ Ù„ØªØ´Ø¹Ø± Ø¨Ø§Ù„Ø§Ø·Ù…Ø¦Ù†Ø§Ù†.",
      GREEN:  "ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ùƒ ØºÙŠØ± Ù…Ø±ØªØ§Ø­ Ø£Ùˆ Ù„Ø§ ØªØ­Ø¨ Ù…Ø§ ÙŠØ­Ø¯Ø« Ù„ÙƒØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø£Ù† ØªØ®Ø¨Ø±Ù†ÙŠ Ø¨Ù…Ø§ ÙŠØ²Ø¹Ø¬Ùƒ Ø£Ùˆ ØªØ¨ØªØ¹Ø¯ Ù‚Ù„ÙŠÙ„Ù‹Ø§ Ù„ØªØ´Ø¹Ø± Ø¨Ø§Ù„Ø±Ø§Ø­Ø©."
    };

    function rgb2hsv(r,g,b){
      r/=255; g/=255; b/=255;
      const max=Math.max(r,g,b), min=Math.min(r,g,b);
      let h=0, s=0, v=max, d=max-min; s=max==0?0:d/max;
      if(d!==0){
        switch(max){ case r:h=((g-b)/d + (g<b?6:0));break;
                      case g:h=((b-r)/d + 2);break;
                      case b:h=((r-g)/d + 4);break; }
        h/=6;
      }
      return {h:h*360, s:s*100, v:v*100};
    }

    // Return one of the five colors, or "NONE" (we do NOT use BLACK/WHITE/UNKNOWN)
    function classify(h,s,v){
      const sMin = +minSat.value, vMaxBlack = +maxValBlack.value, vMin = +minVal.value;
      if (v <= vMaxBlack || s < sMin || v < vMin) return 'NONE';
      if ((h>=0 && h<20) || (h>=340 && h<=360)) return 'RED';
      if (h>=20 && h<65)   return 'YELLOW';
      if (h>=65 && h<170)  return 'GREEN';
      if (h>=170 && h<255) return 'BLUE';
      if (h>=255 && h<320) return 'PURPLE';
      return 'NONE';
    }

    function openPopup(color){ celeText.textContent = messages[color]; cele.classList.add('active'); }
    function closePopup(){ cele.classList.remove('active'); }

    function loop(){
      const vw = video.videoWidth, vh = video.videoHeight;
      if(vw>0 && vh>0){
        canvas.width = vw; canvas.height = vh;
        ctx.drawImage(video,0,0,vw,vh);
        const r = Math.min(vw,vh) * (+roiSize.value/100);
        const x = vw/2 - r/2, y = vh/2 - r/2;
        const img = ctx.getImageData(x,y,r,r);
        let R=0,G=0,B=0,count=0, data=img.data;
        for(let i=0;i<data.length;i+=4){ R+=data[i]; G+=data[i+1]; B+=data[i+2]; count++; }
        R/=count; G/=count; B/=count;
        const {h,s,v} = rgb2hsv(R,G,B);
        const colorNow = classify(h,s,v);

        swatch.style.background = `rgb(${R|0},${G|0},${B|0})`;
        colorNameEl.textContent = (colorNow==='NONE') ? 'â€”' : colorNow;

        if(colorNow === stableColor){ sameCount++; } else { stableColor = colorNow; sameCount = 1; }

        const needStableFrames = 8, cooldown = 800;
        const isTarget = TARGETS.includes(colorNow);

        if(isTarget && sameCount >= needStableFrames && (Date.now()-lastTriggerAt)>cooldown){
          if(colorNow!==lastColor){
            openPopup(colorNow);
            lastColor = colorNow;
            lastTriggerAt = Date.now();
          }
          noColorCount = 0;
        }

        // hide when not seeing the last color anymore
        const lostFrame = (colorNow==='NONE') || (lastColor && colorNow !== lastColor) || sameCount < 2;
        if (lostFrame) noColorCount++; else noColorCount = 0;

        const LOST_FRAMES_TO_HIDE = 12; // ~0.6s at ~20fps
        if (noColorCount >= LOST_FRAMES_TO_HIDE) { closePopup(); lastColor=""; }
      }
      requestAnimationFrame(loop);
    }

    async function start(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video:{ facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} },
          audio:false
        });
        video.srcObject = stream; await video.play();
        loop();
      }catch(e){ alert('ØªØ¹Ø°Ù‘Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. Ø§Ø³Ù…Ø­/ÙŠ Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (HTTPS).'); console.error(e); }
    }
    function stop(){
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      video.srcObject=null; closePopup(); lastColor=""; noColorCount=0; sameCount=0; stableColor="";
    }

    btnStart.onclick = start; btnStop.onclick = stop;
    roiSize.addEventListener('input', ()=>{ const v=+roiSize.value; roiBox.style.width=roiBox.style.height=`min(${v}vmin, ${v*7.5}px)`; });
    roiSize.dispatchEvent(new Event('input'));

    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js').catch(console.error));
    }
  </script>
</body>
</html>
