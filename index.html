<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Ø¹Ø¯Ù‘Ø§Ø¯ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„ØµØºØ§Ø±</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#FF7AC3">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø¨Ø·Ø§Ù„">
  <link rel="apple-touch-icon" href="./icon-192.png">

  <style>
    :root{
      --bg:#FFFAF1;--card:#FFFFFF;--ink:#1f2328;--muted:#6b7280;--accent:#FF7AC3;--border:#ffe3b8;
    }
    *{box-sizing:border-box}
    body{margin:0;background:
      radial-gradient(1200px 600px at 20% -10%, #FFF0D6 0%, var(--bg) 40%),
      radial-gradient(800px 500px at 110% 0%, #FFE6F4 0%, transparent 50%),
      radial-gradient(800px 600px at -5% 100%, #E7F6FF 0%, transparent 50%);
      color:var(--ink);font-family:'Noto Sans Arabic', system-ui, -apple-system, Segoe UI, Roboto, Tahoma, sans-serif}
    header{position:sticky;top:0;background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.75));backdrop-filter:blur(8px);
      border-bottom:2px solid var(--border);padding:10px 16px}
    h1{margin:0;font-size:22px;display:flex;gap:10px;align-items:center}
    .mascot{width:34px;height:34px}

    main{padding:14px;display:grid;gap:14px;max-width:980px;margin:0 auto}
    .card{background:var(--card);border:2px solid var(--border);border-radius:22px;padding:14px;box-shadow:0 6px 20px #00000010}
    .controls{display:flex;flex-wrap:wrap;gap:10px}
    button{border:none;border-radius:16px;padding:12px 16px;font-size:18px;cursor:pointer;transition:.15s transform}
    button:active{transform:scale(.98)}
    .btn-primary{background:linear-gradient(90deg,var(--accent),#FFB86C);color:#2b0b1e}
    .btn{background:#F1F5F9;color:#111827}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:10px 12px;border-radius:999px;background:#F9FAFB;border:2px dashed var(--border)}
    .swatch{width:22px;height:22px;border-radius:8px;border:2px solid #0002}

    .video-wrap{position:relative;border-radius:22px;overflow:hidden;border:2px solid var(--border);background:#000}
    video{width:100%;height:auto;display:block}
    canvas{display:none}
    .roi{position:absolute;border:4px dashed #fff;inset:auto;left:50%;top:50%;transform:translate(-50%,-50%);
      width:min(50vmin,360px);height:min(50vmin,360px);border-radius:20px;box-shadow:0 0 0 6px #00000030 inset}

    .msg{font-size:22px;line-height:1.7;margin:8px 0 0}
    .msg .big{font-weight:800}

    .stickers{display:flex;flex-wrap:wrap;gap:10px}
    .st{display:flex;align-items:center;gap:8px;background:#fff;border:2px solid var(--border);border-radius:16px;padding:8px 12px}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:12px}
    label{font-size:14px;color:var(--muted)}
    input[type=range]{width:100%}

    /* Celebration overlay */
    .celebrate{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35)}
    .celebrate.active{display:grid}
    .cele-card{background:#fff;border:3px solid var(--border);border-radius:28px;padding:18px 22px;min-width:min(90vw,520px);text-align:center;
      box-shadow:0 24px 60px #00000040}
    .cele-title{font-size:28px;margin:0 0 8px}
    .cele-text{font-size:22px;margin:0}
    .emoji{font-size:56px}

    .footer{opacity:.7;font-size:12px;text-align:center;margin:6px 0}
  </style>
</head>
<body>
  <header>
    <h1>
      <svg class="mascot" viewBox="0 0 64 64" aria-hidden="true">
        <defs><linearGradient id="g" x1="0" x2="1">
          <stop offset="0%" stop-color="#FF7AC3"/><stop offset="100%" stop-color="#60A5FA"/>
        </linearGradient></defs>
        <circle cx="32" cy="32" r="30" fill="url(#g)"/>
        <circle cx="24" cy="26" r="5" fill="#fff"/><circle cx="40" cy="26" r="5" fill="#fff"/>
        <path d="M20 42q12 10 24 0" stroke="#fff" stroke-width="5" fill="none" stroke-linecap="round"/>
      </svg>
      Ø¹Ø¯Ù‘Ø§Ø¯ Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„ØµØºØ§Ø±
    </h1>
  </header>

  <main>
    <section class="card">
      <div class="controls">
        <button class="btn-primary" id="btnStart">ğŸ¥ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        <button class="btn" id="btnStop">â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
        <span class="pill"><span class="swatch" id="swatch"></span><span id="colorName">â€”</span></span>
      </div>

      <div class="video-wrap">
        <video id="video" playsinline autoplay muted></video>
        <div class="roi" id="roi"></div>
      </div>

      <canvas id="canvas"></canvas>

      <p class="msg" id="msg">
        â­ï¸ <span class="big">Ù‡ÙŠØ§ ÙŠØ§ Ø¨Ø·Ù„/Ø©!</span>
        Ø¶Ø¹/ÙŠ Ø§Ù„ÙƒØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ù†Ù‚Ù‘Ø· Ù„ÙŠÙƒØªØ´Ù Ø§Ù„Ù„ÙˆÙ† ÙˆÙŠØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ù…Ø±ÙØ­Ø© Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©.
        Ø¬Ø±Ù‘Ø¨ÙˆØ§ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ø³ÙˆØ¯Ø§Ø¡ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©.
      </p>

      <div class="stickers" aria-hidden="true">
        <div class="st">ğŸŸ¡ Ø£ØµÙØ± = Ø³Ø¹Ø§Ø¯Ø©</div>
        <div class="st">ğŸ”µ Ø£Ø²Ø±Ù‚ = Ø­Ø²Ù†</div>
        <div class="st">ğŸ”´ Ø£Ø­Ù…Ø± = ØºØ¶Ø¨</div>
        <div class="st">ğŸŸ£ Ø¨Ù†ÙØ³Ø¬ÙŠ = Ø®ÙˆÙ</div>
        <div class="st">ğŸŸ¢ Ø£Ø®Ø¶Ø± = Ø¹Ø¯Ù… Ø§Ø±ØªÙŠØ§Ø­</div>
      </div>
    </section>

    <section class="card grid">
      <div>
        <label>Ø­Ø¬Ù… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù‚ÙŠØ§Ø³</label>
        <input type="range" id="roiSize" min="30" max="80" value="50" />
      </div>
      <div>
        <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„ØªØ´Ø¨Ø¹ (S)</label>
        <input type="range" id="minSat" min="0" max="100" value="25" />
      </div>
      <div>
        <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø¥Ø¶Ø§Ø¡Ø© (V)</label>
        <input type="range" id="minVal" min="0" max="100" value="20" />
      </div>
      <div>
        <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ù„Ø¥Ø¶Ø§Ø¡Ø© (Ù„Ù„Ø£Ø³ÙˆØ¯)</label>
        <input type="range" id="maxValBlack" min="0" max="100" value="18" />
      </div>
    </section>

    <section class="card">
      <strong>Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„:</strong>
      <ul>
        <li><b>Ø§Ù„Ø£ØµÙØ±</b> â†’ "ÙŠØ§ Ø³Ù„Ø§Ù…! ØªØ¨Ø¯Ùˆ Ø³Ø¹ÙŠØ¯Ù‹Ø§ ğŸ˜Š Ø§Ø­ÙƒÙ Ù„Ù†Ø§ Ù…Ø§ Ø§Ù„Ø°ÙŠ Ø£Ø³Ø¹Ø¯Ùƒ Ø§Ù„ÙŠÙˆÙ…."</li>
        <li><b>Ø§Ù„Ø£Ø²Ø±Ù‚</b> â†’ "ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ùƒ Ø­Ø²ÙŠÙ† ğŸ˜¢ â€” Ø§Ù„Ø­Ø²Ù† Ø·Ø¨ÙŠØ¹ÙŠ. ØªØ¹Ø§Ù„ Ù†ØªØ­Ø§Ø¯Ø« Ù‚Ù„ÙŠÙ„Ù‹Ø§."</li>
        <li><b>Ø§Ù„Ø£Ø­Ù…Ø±</b> â†’ "ØºØ¶Ø¨Ø§Ù†ØŸ ğŸ˜¡ Ø®Ø° Ø´Ù‡ÙŠÙ‚Ù‹Ø§ Ø¹Ù…ÙŠÙ‚Ù‹Ø§ Ø«Ù… Ø²ÙÙŠØ±â€¦ Ø£Ø­Ø³Ù†Øª!"</li>
        <li><b>Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠ</b> â†’ "Ù‡Ù„ ØªØ´Ø¹Ø± Ø¨Ø§Ù„Ø®ÙˆÙØŸ ğŸ«£ Ø£Ù†Øª Ø¨Ø£Ù…Ø§Ù† Ù…Ø¹Ù†Ø§."</li>
        <li><b>Ø§Ù„Ø£Ø®Ø¶Ø±</b> â†’ "Ù…Ù…â€¦ Ù‡Ø°Ø§ Ù„Ø§ ÙŠØ¹Ø¬Ø¨Ùƒ ğŸ¤¢ØŸ Ø§Ø®Ø¨Ø±Ù†Ø§ Ø¨Ù…Ø§ ÙŠØ²Ø¹Ø¬Ùƒ Ø£Ùˆ Ø®Ø° Ø§Ø³ØªØ±Ø§Ø­Ø©."</li>
      </ul>
      <div class="footer">Ù†ØµÙŠØ­Ø©: Ø§Ø¶Ø¨Ø·ÙˆØ§ Ø§Ù„Ù…Ù†Ø²Ù„Ù‚Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø© ÙÙŠ Ø§Ù„ØºØ±ÙØ©.</div>
    </section>
  </main>

  <!-- Celebration overlay -->
  <div class="celebrate" id="cele">
    <div class="cele-card">
      <div class="emoji" id="celeEmoji">ğŸ‰</div>
      <h2 class="cele-title" id="celeTitle">Ø£Ø­Ø³Ù†Øª ÙŠØ§ Ø¨Ø·Ù„/Ø©!</h2>
      <p class="cele-text" id="celeText">ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù„ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­.</p>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const roiBox = document.getElementById('roi');
    const roiSize = document.getElementById('roiSize');
    const minSat = document.getElementById('minSat');
    const minVal = document.getElementById('minVal');
    const maxValBlack = document.getElementById('maxValBlack');
    const swatch = document.getElementById('swatch');
    const colorNameEl = document.getElementById('colorName');
    const msgEl = document.getElementById('msg');

    const cele = document.getElementById('cele');
    const celeEmoji = document.getElementById('celeEmoji');
    const celeTitle = document.getElementById('celeTitle');
    const celeText  = document.getElementById('celeText');

    let stream=null, rafId=null, lastColor="";
    let lastTriggerAt = 0;             // cooldown
    let stableColor = ""; let sameCount = 0; // stability
    let wakeLock = null;
    let noColorCount = 0;              // counts frames with no/other color

    const TARGETS = ['RED','GREEN','BLUE','YELLOW','PURPLE'];
    const messages = {
      YELLOW: "ÙŠØ§ Ø³Ù„Ø§Ù…! ØªØ¨Ø¯Ùˆ Ø³Ø¹ÙŠØ¯Ù‹Ø§ ğŸ˜Š Ø§Ø­ÙƒÙ Ù„Ù†Ø§ Ù…Ø§ Ø§Ù„Ø°ÙŠ Ø£Ø³Ø¹Ø¯Ùƒ Ø§Ù„ÙŠÙˆÙ….",
      BLUE:   "ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ùƒ Ø­Ø²ÙŠÙ† ğŸ˜¢ â€” Ø§Ù„Ø­Ø²Ù† Ø·Ø¨ÙŠØ¹ÙŠ. ØªØ¹Ø§Ù„ Ù†ØªØ­Ø§Ø¯Ø« Ù‚Ù„ÙŠÙ„Ù‹Ø§.",
      RED:    "ØºØ¶Ø¨Ø§Ù†ØŸ ğŸ˜¡ Ø®Ø° Ø´Ù‡ÙŠÙ‚Ù‹Ø§ Ø¹Ù…ÙŠÙ‚Ù‹Ø§ Ø«Ù… Ø²ÙÙŠØ±â€¦ Ø£Ø­Ø³Ù†Øª!",
      PURPLE: "Ù‡Ù„ ØªØ´Ø¹Ø± Ø¨Ø§Ù„Ø®ÙˆÙØŸ ğŸ«£ Ø£Ù†Øª Ø¨Ø£Ù…Ø§Ù† Ù…Ø¹Ù†Ø§.",
      GREEN:  "Ù…Ù…â€¦ Ù‡Ø°Ø§ Ù„Ø§ ÙŠØ¹Ø¬Ø¨Ùƒ ğŸ¤¢ØŸ Ø§Ø®Ø¨Ø±Ù†Ø§ Ø¨Ù…Ø§ ÙŠØ²Ø¹Ø¬Ùƒ Ø£Ùˆ Ø®Ø° Ø§Ø³ØªØ±Ø§Ø­Ø©.",
      WHITE:  "Ø¥Ø¶Ø§Ø¡Ø© Ù‚ÙˆÙŠØ© Ø¬Ø¯Ù‹Ø§ âœ¨",
      BLACK:  "Ø¥Ø¶Ø§Ø¡Ø© Ø¶Ø¹ÙŠÙØ© Ø¬Ø¯Ù‹Ø§ ğŸŒ™",
      UNKNOWN:"Ù„Ù… Ø£ÙÙ‡Ù… Ø§Ù„Ù„ÙˆÙ†â€¦ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."
    };

    function rgb2hsv(r,g,b){
      r/=255; g/=255; b/=255;
      const max=Math.max(r,g,b), min=Math.min(r,g,b);
      let h=0, s=0, v=max; const d=max-min; s=max==0?0:d/max;
      if(d!==0){
        switch(max){
          case r: h=((g-b)/d + (g<b?6:0)); break;
          case g: h=((b-r)/d + 2); break;
          case b: h=((r-g)/d + 4); break;
        }
        h/=6;
      }
      return {h:h*360, s:s*100, v:v*100};
    }

    function classify(h,s,v){
      const sMin = +minSat.value;
      const vMaxBlack = +maxValBlack.value;
      if(v <= vMaxBlack) return 'BLACK';
      if(s < sMin && v >= 85) return 'WHITE';
      if(s < sMin) return 'UNKNOWN';
      if((h>=0 && h<20) || (h>=340 && h<=360)) return 'RED';
      if(h>=20 && h<65)  return 'YELLOW';
      if(h>=65 && h<170) return 'GREEN';
      if(h>=170 && h<255) return 'BLUE';
      if(h>=255 && h<320) return 'PURPLE';
      return 'UNKNOWN';
    }

    function playChime(){
      if(!window.AudioContext) return;
      const actx = new AudioContext();
      const o = actx.createOscillator();
      const g = actx.createGain();
      o.type='sine'; o.frequency.setValueAtTime(880, actx.currentTime);
      g.gain.setValueAtTime(0.0001, actx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2, actx.currentTime+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, actx.currentTime+0.4);
      o.connect(g).connect(actx.destination); o.start(); o.stop(actx.currentTime+0.45);
    }

    function openPopup(color){
      const map = {RED:'ğŸ˜¡', BLUE:'ğŸ˜¢', YELLOW:'ğŸ˜Š', GREEN:'ğŸ¤¢', PURPLE:'ğŸ«£', WHITE:'âœ¨', BLACK:'ğŸŒ™'};
      celeEmoji.textContent = map[color] || 'ğŸ‰';
      celeTitle.textContent = 'Ø£Ø­Ø³Ù†Øª ÙŠØ§ Ø¨Ø·Ù„/Ø©!';
      celeText.textContent = messages[color] || messages.UNKNOWN;
      cele.classList.add('active');
      playChime();
      confettiOnce();
    }
    function closePopup(){
      cele.classList.remove('active');
    }

    function confettiOnce(){
      const n=80; const W=window.innerWidth, H=window.innerHeight;
      const cvs=document.createElement('canvas');
      cvs.style.position='fixed'; cvs.style.inset='0'; cvs.style.pointerEvents='none';
      document.body.appendChild(cvs); const x=cvs.getContext('2d'); cvs.width=W; cvs.height=H;
      const parts=[...Array(n)].map(()=>({ x:Math.random()*W, y:-20-Math.random()*H/2, r:3+Math.random()*5,
        c:`hsl(${Math.random()*360},80%,60%)`, s:1+Math.random()*2 }));
      let t=0; (function anim(){
        x.clearRect(0,0,W,H); t+=16;
        parts.forEach(p=>{p.y+=p.s; p.x+=Math.sin((p.y+t)/40); x.fillStyle=p.c; x.beginPath(); x.arc(p.x,p.y,p.r,0,Math.PI*2); x.fill();});
        if(t<1200) requestAnimationFrame(anim); else document.body.removeChild(cvs);
      })();
    }

    function loop(){
      const vw = video.videoWidth, vh = video.videoHeight;
      if(vw>0 && vh>0){
        canvas.width = vw; canvas.height = vh;
        ctx.drawImage(video,0,0,vw,vh);
        const r = Math.min(vw,vh) * (+roiSize.value/100);
        const x = vw/2 - r/2, y = vh/2 - r/2;
        const img = ctx.getImageData(x,y,r,r);
        let R=0,G=0,B=0,count=0; const data = img.data;
        for(let i=0;i<data.length;i+=4){ R+=data[i]; G+=data[i+1]; B+=data[i+2]; count++; }
        R/=count; G/=count; B/=count;
        const {h,s,v} = rgb2hsv(R,G,B);
        const colorNow = classify(h,s,v);
        swatch.style.background = `rgb(${R|0},${G|0},${B|0})`;
        colorNameEl.textContent = `${colorNow} Â· H:${h|0} S:${s|0}% V:${v|0}%`;

        // stability tracking
        if(colorNow === stableColor){ sameCount++; } else { stableColor = colorNow; sameCount = 1; }

        // --- TRIGGER when stable TARGET color detected ---
        const needStableFrames = 8;
        const cooldown = 800;
        const isTarget = TARGETS.includes(colorNow);

        if(isTarget && sameCount >= needStableFrames && (Date.now() - lastTriggerAt) > cooldown){
          msgEl.textContent = messages[colorNow] || messages.UNKNOWN;
          if(colorNow!==lastColor){
            openPopup(colorNow);
            lastColor=colorNow;
            lastTriggerAt=Date.now();
          }
          noColorCount = 0; // reset the "lost color" counter
        }

        // --- AUTO-HIDE when color no longer visible ---
        // Count frames where we *don't* see the same target color
        // Conditions that count as "lost":
        //   - not a target (UNKNOWN/WHITE/BLACK), or
        //   - target but different from lastColor, or
        //   - unstable (sameCount < 2)
        const lostFrame =
          !isTarget ||
          (isTarget && lastColor && colorNow !== lastColor) ||
          sameCount < 2;

        if (lostFrame) {
          noColorCount++;
        } else {
          // still seeing the same color; keep it at 0
          noColorCount = 0;
        }

        // After N consecutive "lost" frames, hide popup
        const LOST_FRAMES_TO_HIDE = 12; // ~12 frames â‰ˆ ~0.6s at 20fps (tune if needed)
        if (noColorCount >= LOST_FRAMES_TO_HIDE) {
          closePopup();
          lastColor = ""; // allow next color to retrigger cleanly
        }
      }
      rafId = requestAnimationFrame(loop);
    }

    async function start(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height:{ ideal: 720 } },
          audio: false
        });
        video.srcObject = stream; await video.play();

        try{
          if ('wakeLock' in navigator) { wakeLock = await navigator.wakeLock.request('screen'); }
        }catch(e){ /* ignore */ }

        loop();
      }catch(e){
        alert('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§. Ø§Ø³Ù…Ø­/ÙŠ Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (HTTPS).');
        console.error(e);
      }
    }

    function stop(){
      cancelAnimationFrame(rafId);
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      video.srcObject=null;
      if(wakeLock){ try{ wakeLock.release(); }catch(e){} wakeLock=null; }
      closePopup();
      lastColor = "";
      noColorCount = 0;
      sameCount = 0;
      stableColor = "";
    }

    btnStart.onclick = start; btnStop.onclick = stop;
    roiSize.addEventListener('input', ()=>{
      const v = +roiSize.value; roiBox.style.width = roiBox.style.height = `min(${v}vmin, ${v*7.5}px)`;
    });
    roiSize.dispatchEvent(new Event('input'));

    // register service worker (PWA)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(console.error);
      });
    }
  </script>
</body>
</html>
